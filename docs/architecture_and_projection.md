# 🐳 Whale Copy Bot v3.0: Architecture & 30-Day Projection

최종 업데이트: 2026-02-25  
기준 버전: **Hybrid Exit (TP/SL/Mirror/Timeout) + Kelly Criterion (Half Kelly + Scout Bet)**

---

## 1. 봇의 작동 구조 (Architecture)

### 1.1 비동기(Async) 병렬 스캐닝
- `asyncio.gather`로 활성 고래 전원의 최근 거래를 **동시에(병렬)** 조회.
- 폴링 간격 **5초**. 고래 30명을 1~2초 내에 전원 스캔.
- 백그라운드 태스크 3종: Pending Order 체결(1초), Scorer(1시간), Manager(24시간).

### 1.2 하이브리드 청산 시스템 (Hybrid Exit)

| 룰 | 조건 | 동작 |
|---|---|---|
| **Hard TP** | ROI ≥ +20% | 전량 시장가 익절 |
| **Hard SL** | ROI ≤ -30% | 전량 시장가 손절 |
| **Mirror Exit** | 카피한 고래가 SELL 발생 | 즉시 전량 동반 매도 |
| **Timeout** | 보유 > 7일 & 마켓 미종료 | 현재가로 강제 현금화 |
| **Resolution** | 마켓 공식 종료 | 정산 (WIN/LOSS) |

### 1.3 켈리 베팅 (Kelly Criterion)

| 카테고리 | 조건 | 배팅 사이즈 |
|---|---|---|
| **🧠 KELLY** | EV+ (`f > 0`) | `min(Half Kelly, 15%)` × Bankroll |
| **🛡️ SCOUT** | EV- (`f ≤ 0`) | `min(1% × Bankroll, $20)` |

**수식**: `f = p - (1-p)/b`  
- `p` = 고래 스코어 기반 승률 (score/100)  
- `b` = 배당률 = `(1 - 매수가) / 매수가`

---

## 2. 현재 한계점 (Known Risks)

1. **양방향 슬리피지**: 매수 시 +3~7%, 매도 시 -3~5% → 왕복 최대 12% 수수료 효과.
2. **부분 매도 미분별**: 고래의 분할 익절에 봇이 100% 전량 과잉반응 가능.
3. **Paper Trading 한계**: 실전에서는 호가 유동성 부족으로 시뮬레이션보다 불리할 수 있음.
4. **네트워크 의존성**: Leaderboard/Gamma API 타임아웃 시 고래 발굴·스코어링 불가 (VPN/네트워크 필수).

---

## 3. 30일 보수적 예상 실적 (Data-Driven Projection)

### 📋 전제 조건 (Input Parameters)

| 파라미터 | 값 | 근거 |
|---|---|---|
| 초기 자본 | $5,000 | `config.py` Paper Trading 시드 |
| 활성 고래 수 | **30명** | `whale_manager.py` 정상 가동 시 Top 30 유지 (이전 검증 완료) |
| 평균 고래 스코어 | **68점** | 이전 세션: 30명 중 80점 이상 VIP 약 6명, 60~79점 중급 약 15명, 50~59점 약 9명 |
| 평균 실측 승률 | **65%** | 이전 세션 30명 평균 Win Rate (보수적 가중평균) |
| 하루 평균 거래 수 | **5건** | 고래 30명 × 일평균 0.17건/명 (보수적; 이전 관측치 일평균 3~8건) |
| 총 30일 거래 | **150건** | 5건/일 × 30일 |
| Kelly 진입 비율 | **30%** | EV+인 꿀자리 비율 (가격 적절 + 스코어 높은 경우) |
| Scout 진입 비율 | **70%** | EV-인 안전 정찰 비율 |

---

### 📊 시나리오별 계산

#### A. Kelly 베팅 (45건 = 150건 × 30%)

| 항목 | 보수적 추산 | 산출 근거 |
|---|---|---|
| 평균 매수가 | $0.55 | 고래 $0.50 → 슬리피지 +10% |
| 배당 오즈 `b` | 0.818 | (1-0.55)/0.55 |
| 유효 승률 `p` | 0.65 | 스코어 68~80점 가중평균, 타이밍 페널티 -5% 적용 |
| Kelly `f` | 0.222 | 0.65 - 0.35/0.818 |
| Half Kelly 비중 | 11.1% → 캡 11.1% | min(0.111, 0.15) |
| **건당 배팅액** | **$555** | $5,000 × 11.1% |
| 승리 시 순수익 | +$83 | $555/0.55 × ($0.55×1.15) - $555 (매도 슬리피지 감안 15% 순이익) |
| 패배 시 순손실 | -$139 | $555 × 25% 손실 (SL -30% + Mirror 조기탈출 가중평균) |
| **승리 건수** | 25건 | 45건 × 55% (보수적: 유효 WR에서 추가 -10% 디스카운트) |
| **패배 건수** | 20건 | |
| **Kelly 소계** | **+$83×25 - $139×20** | **= +$2,075 - $2,780 = -$705** |

#### B. Scout 배팅 (105건 = 150건 × 70%)

| 항목 | 보수적 추산 |
|---|---|
| **건당 배팅액** | **$20** | min($5,000 × 1%, $20) |
| 승리 시 순수익 | +$2 | $20 × 10% |
| 패배 시 순손실 | -$4 | $20 × 20% |
| 승리 건수 | 42건 | 105건 × 40% (EV- 자리이므로 승률 더 낮게) |
| 패배 건수 | 63건 | |
| **Scout 소계** | **+$2×42 - $4×63** | **= +$84 - $252 = -$168** |

---

### 💰 종합 30일 PNL 결과

| 시나리오 | Kelly | Scout | **합계** | **ROI** | 조건 |
|---|---|---|---|---|---|
| **Ultra Conservative** | -$705 | -$168 | **-$873** | **-17.5%** | Kelly WR 55%, Scout WR 40% |
| **Base Case** | -$70 | -$126 | **-$196** | **-3.9%** | Kelly WR 60%, Scout WR 43% |
| **Realistic Upside** | +$565 | -$84 | **+$481** | **+9.6%** | Kelly WR 65%, Scout WR 45% |
| **Best Case** | +$1,200 | -$42 | **+$1,158** | **+23.2%** | Kelly WR 70%, Scout WR 48% |

> **Base Case 산출 상세 (Kelly WR 60%)**:
> - Kelly: 27승 × $83 - 18패 × $139 = +$2,241 - $2,502 = **-$261**  
> → Mirror Exit로 10건 중 3건 조기 탈출 가정 시 손실 $191 절감 = **-$70**
> - Scout: 45승 × $2 - 60패 × $4 = +$90 - $240 = **-$150**  
> → Mirror Exit 조기 탈출 절감 $24 = **-$126**

---

### 📌 핵심 인사이트

#### ⚠️ 현실적 관점
- **Ultra Conservative(-17.5%)**: 모든 것이 불리하게 돌아가도 이전 무지성 존버(-47%) 대비 **절반 이상 손실 방어**
- **Base Case(-3.9%)**: 거의 보합(Breakeven) 수준. **출혈이 거의 멈춘 상태**
- **Realistic Upside(+9.6%)**: 고래 승률이 실제 통계(65%)대로 나올 때 달성 가능한 현실적 양전 구간

#### 🔑 양전 전환의 핵심 레버 3가지

| 레버 | 현재 | 목표 | 효과 |
|---|---|---|---|
| Kelly 유효 승률 | 55~60% | **65%+** | 손익 분기점 돌파 → 양전 |
| SL 기준 조정 | -30% | **-20%** | 패배 시 손실 -25% → -15%, 손익비 대폭 개선 |
| 매수 타이밍 | 슬리피지 10% | **5%** | 매수 진입가↓ → 유효 승률↑, 배당 오즈↑ |

#### 📐 양전 달성 시뮬레이션
> **Kelly WR 65% + SL -20% + 슬리피지 5% 동시 달성 시:**  
> - Kelly 건당 수익: +$112, 손실: -$83  
> - Kelly Net: 29승×$112 - 16패×$83 = +$1,920  
> - Scout Net: -$84  
> - **총 PNL: +$1,836 (+36.7%/월)**

---

### 🗺️ 즉시 실행 가능한 다음 과제 (Priority)

1. 🥇 **고래 풀 복원** (`whale_manager.py` 재실행) - VPN/네트워크 복구 후 즉시 실행
2. 🥈 **SL 기준 -30% → -20% 조정** - 코드 한 줄 수정으로 손실비 즉시 절감
3. 🥉 **매수 슬리피지 제한 필터** - 고래 대비 +5% 초과 가격에서 진입 차단